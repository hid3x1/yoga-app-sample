# ヨガレッスンアプリケーション - アーキテクチャドキュメント

## 1. 概要

本ドキュメントでは、カメラを使用してユーザーのヨガポーズを認識・評価するレッスンアプリケーションのアーキテクチャについて詳述する。当アプリケーションはネイティブプラットフォームを主軸とし、後にWebへの展開も視野に入れている。開発手法にはテスト駆動開発（TDD）を採用し、1人での開発・運用を前提としている。

### 主要機能

- カメラを用いたリアルタイムヨガポーズ認識（MediaPipe Pose活用）
- ポーズの正確性評価とフィードバック提供
- ユーザー会員登録と認証
- レッスン進捗・履歴管理（カレンダー表示）
- 将来的なクーポン機能の統合

## 2. アーキテクチャ選択と根拠

### 2.1 採用アーキテクチャ

**クリーンアーキテクチャ + MVVM + リアルタイム処理層**

このハイブリッドアプローチにより、クリーンアーキテクチャの関心事分離の利点と、MVVMパターンのデータバインディングの容易さ、さらにリアルタイム処理の特殊性を考慮した設計が可能になる。

### 2.2 選択理由

- **関心事の明確な分離**：ドメインロジック、UI、データアクセス、リアルタイム処理が独立しており、変更の影響範囲が限定される
- **テスト容易性**：各層を独立してテスト可能。特にリアルタイム処理のモック化が容易
- **拡張性**：会員管理やクーポン機能などの追加が構造的に容易
- **プラットフォーム非依存**：コアロジックがプラットフォーム技術から独立しており、将来のWeb展開が容易
- **保守性**：1人開発でも長期的な保守が容易な構造

### 2.3 採用しない選択肢

- **モノリシックMVC**：カメラ処理とビジネスロジックの混在によりテスト困難
- **マイクロサービス**：1人開発には複雑すぎ、運用コストが高い
- **サーバー依存型アーキテクチャ**：ネットワーク遅延によるUX低下、プライバシー懸念
- **イベントソーシング**：学習曲線が急で要件に対して過剰

## 3. レイヤー構成

### 3.1 プレゼンテーション層
- **View**：ユーザーインターフェース（画面表示、ユーザー入力受付）
- **ViewModel**：ビューとドメインロジックの中間層（状態管理、コマンド処理）

### 3.2 ドメイン層
- **ユースケース**：アプリケーション固有のビジネスロジック
- **エンティティ**：ビジネスモデルとルール

### 3.3 データ層
- **リポジトリ**：データアクセスの抽象化
- **データソース**：具体的なデータアクセス実装（APIクライアント、ローカルDB）

### 3.4 リアルタイム処理層
- **カメラ管理**：カメラ入力とフレーム処理
- **ポーズ認識**：MediaPipe連携と骨格データ処理
- **ポーズ評価**：リアルタイムフィードバック生成

## 4. 主要コンポーネント

### 4.1 プレゼンテーション層
- **レッスン画面**：カメラプレビュー、ポーズガイダンス、フィードバック表示
- **プロフィール画面**：ユーザー情報管理
- **履歴画面**：カレンダー形式の練習記録
- **設定画面**：アプリ設定管理
- **クーポン画面**：利用可能なクーポン表示（将来実装）

### 4.2 ドメイン層
- **ヨガポーズモデル**：各ポーズの特性と基準
- **レッスンモデル**：レッスン構成と進行ロジック
- **ユーザーモデル**：ユーザー情報と認証
- **進捗モデル**：練習履歴と成果追跡
- **クーポンモデル**：特典と適用条件（将来実装）

### 4.3 データ層
- **ユーザーリポジトリ**：認証・プロフィール管理
- **レッスンリポジトリ**：レッスンコンテンツ管理
- **進捗リポジトリ**：練習履歴保存
- **クーポンリポジトリ**：クーポン情報管理（将来実装）

### 4.4 リアルタイム処理層
- **カメラマネージャ**：カメラ操作と最適化
- **ポーズ検出マネージャ**：MediaPipe連携
- **骨格データプロセッサ**：検出データの処理と変換
- **ポーズ評価エンジン**：リアルタイム評価ロジック

## 5. データフロー

### 5.1 ポーズ認識フロー
1. カメラがフレームをキャプチャ
2. リアルタイム処理層がMediaPipeを使用して骨格データを抽出
3. 骨格データがドメイン層のポーズモデルに変換
4. ユースケース層がポーズを評価
5. 結果がViewModelを通じてUIに反映

### 5.2 ユーザー認証フロー
1. ユーザーが認証情報を入力
2. ViewModelがユーザー認証ユースケースを呼び出し
3. リポジトリがデータストアと通信
4. 認証結果がUI層に反映

### 5.3 練習履歴記録フロー
1. レッスン完了時にViewModel経由で記録ユースケース実行
2. 進捗データがリポジトリを通じてデータストアに保存
3. カレンダー画面で履歴表示時にリポジトリから取得

### 5.4 クーポン利用フロー（将来実装）
1. ユーザーがクーポン画面でクーポンを選択
2. ViewModelがクーポン適用ユースケースを呼び出し
3. クーポンの有効性確認と適用処理
4. 適用結果がUI層に反映

## 6. テスト戦略

### 6.1 ユニットテスト
- **ドメインロジック**：ポーズ評価ロジック、ビジネスルールのテスト
- **ViewModel**：状態管理、コマンド処理のテスト
- **リポジトリ**：データアクセスロジックのテスト（モック利用）

### 6.2 統合テスト
- **ユースケース**：複数コンポーネント連携のテスト
- **データフロー**：エンドツーエンドの動作確認

### 6.3 リアルタイム処理テスト
- **録画データ**：事前録画した骨格データによるリプレイテスト
- **モックカメラ**：仮想カメラ入力によるテスト

### 6.4 UIテスト
- **画面遷移**：ナビゲーションフローの確認
- **表示検証**：各UIコンポーネントの表示と挙動確認

## 7. 拡張性考慮

### 7.1 会員管理システム
- **認証プロバイダー**：外部認証サービス連携（Firebase Auth等）
- **プロフィール管理**：ユーザー情報のCRUD操作

### 7.2 練習記録システム
- **ローカルストレージ**：オフライン利用のためのデータ永続化
- **同期メカニズム**：クラウド同期による複数デバイス対応

### 7.3 クーポン機能（将来実装）
- **クーポン管理**：クーポンの作成、配布、有効期限管理
- **適用ロジック**：特定の条件下でのクーポン適用処理
- **通知システム**：新規クーポン獲得時の通知機能

## 8. 開発ロードマップ

### フェーズ1：コア機能
- リアルタイム処理層の構築
- ポーズ検出と評価ロジック実装
- 基本UI構築

### フェーズ2：ユーザー管理
- 認証システム実装
- プロフィール管理
- データ永続化

### フェーズ3：コンテンツ拡充
- レッスンコンテンツ拡充
- 進捗追跡機能実装
- カレンダー表示

### フェーズ4：クーポン機能
- クーポンモデル設計
- クーポン管理画面実装
- 通知システム統合

## 9. 技術選定

### モバイル開発
- **iOS**: Swift + SwiftUI + Combine
- **Android**: Kotlin + Jetpack Compose + Flow/Coroutines

### リアルタイム処理
- **MediaPipe**: ポーズ検出
- **CoreML/TensorFlow Lite**: カスタムモデル（必要に応じて）

### データ永続化
- **ローカル**: Realm / SQLite / Core Data
- **クラウド**: Firebase / AWS Amplify

### 認証
- Firebase Authentication / Auth0

### Web展開（将来）
- React / Vue.js + WebAssembly（リアルタイム処理用）

## 10. 結論

クリーンアーキテクチャをベースとしたMVVMパターンとリアルタイム処理層の統合により、カメラベースのヨガレッスンアプリに適した拡張性と保守性の高い構造を実現できる。テスト駆動開発との親和性も高く、1人開発での長期運用に適している。将来的な機能拡張（会員管理、練習記録、クーポン機能）も見据えた設計となっている。
