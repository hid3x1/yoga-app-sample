# フェーズ1実装のための主要要件

## エラーケース対応要件

### カメラ関連エラー
- **カメラ権限なし**: 
  - 権限リクエスト画面への誘導と説明
  - 権限許可の理由とメリットの明確な説明
  - 拒否された場合の代替フロー提供（静止画ガイド）
- **カメラ起動失敗**: 
  - 原因別の診断と対応策表示
  - 再試行オプションと段階的なトラブルシューティング
  - デバイス再起動推奨など具体的な解決策の提示
- **照明不足**: 
  - 照度センサーによる自動検知
  - ライトモード自動提案（ユーザー承認後に使用）
  - 明るい場所への移動を促す視覚的ガイド表示
- **姿勢検出失敗**: 
  - 3段階の再試行メカニズム実装
  - 失敗パターン分析とユーザーガイド生成
  - スマートリカバリー（部分的検出結果の活用）

### 姿勢分析関連
- **精度閾値**: 
  - 検出信頼度70%以下の場合は警告表示
  - 50%以下の場合はユーザー位置調整ガイド表示
  - 30%以下の場合は代替モードへの切替提案
- **フレームレート低下**: 
  - 10FPS以下で警告表示
  - デバイス負荷警告とシンプルモードへの切り替えオプション
  - 段階的な機能低減による性能維持戦略
- **バッテリー消費**: 
  - 20%以下でバッテリー警告表示
  - 10%以下で省エネモード自動適用
  - バックグラウンド通知による長時間使用警告

### ネットワークエラー（フェーズ2向け準備）
- **オフライン状態検知**: ネットワーク状態監視と自動モード切替
- **同期失敗対応**: ローカルキューイングと再接続時の自動同期
- **部分的データ損失**: 整合性チェックとリカバリーメカニズム

## パフォーマンス最適化要件
- **カメラ解像度**: 
  - デフォルト: 640x480
  - 高性能デバイス: 1280x720（オプション）
  - 低性能デバイス: 320x240（自動調整）
- **検出間隔**: 
  - 標準: 50ms（約20FPS）
  - パワーセーブモード: 200ms（約5FPS）
  - パフォーマンスモード: 33ms（約30FPS）
- **リソース消費**: 
  - バックグラウンド時にはカメラと検出を自動停止
  - 一定時間操作なしで省電力モードに自動切替
  - CPUとGPUの使用率モニタリングと最適化

## メモリ管理要件
- **メモリリーク防止**: 
  - 明示的なリソース解放（dispose パターン実装）
  - 定期的なメモリ使用量チェックと警告システム
  - 画像バッファの再利用によるGC負荷低減
- **キャッシュ戦略**: 
  - ポーズデータのLRUキャッシュ実装（最大100アイテム）
  - 計算結果の一時キャッシュ（パフォーマンス向上）
  - 画面遷移時のメモリクリーンアップ処理

## デバイス対応戦略
- **最小動作環境**: 
  - iOS: iPhone 8以降
  - Android: Snapdragon 660同等以上（4GB RAM以上）
- **最適化ターゲット**:
  - iOS: iPhone 11以降
  - Android: Snapdragon 845以上（6GB RAM以上）
- **フォールバック戦略**: 
  - 低スペックデバイス向けに軽量モード自動適用
  - オプション機能の段階的無効化（アニメーション→高精度検出→リアルタイム分析）
  - 古いOSでは基本機能のみ対応（OS別の分岐処理）

## アクセシビリティ対応
- **色覚異常対応**: 
  - 赤緑色覚異常用の代替カラースキーム
  - 高コントラストモードオプション
  - パターン認識による強調表示
- **音声支援**: 
  - 主要操作の音声ガイド
  - ポーズ調整のための音声フィードバック
  - 目の不自由なユーザー向けの代替フロー
- **操作支援**: 
  - 大きなタッチターゲット（最小44x44px）
  - 片手操作モードオプション
  - 動作の遅いデバイス向けの待機表示

## ユーザーデータ管理
- **保存データ構造**: 
  - 添付JSONスキーマに準拠
  - バージョン管理対応（将来のスキーマ変更に備える）
  - データ整合性チェック機能
- **プライバシー対応**: 
  - カメラ映像は処理後に即時破棄（メモリ上のみ）
  - ユーザーデータは暗号化して保存
  - ハッシュによるユーザー匿名化（フェーズ2）
- **オフラインモード**: 
  - 100%オフラインで動作可能な設計
  - データ同期状態の明示的表示
  - オフライン使用データの統合ロジック（フェーズ2）

## テスト対象シナリオ
1. 初回起動からレッスン完了までの基本フロー
   - チュートリアルスキップを含む複数パターン
   - 各ステップでのエラー回復テスト
2. 様々な環境条件下でのテスト
   - 照明条件別（明るい/暗い/逆光）検出精度
   - 背景複雑さ別（単色/複雑/動的）検出安定性
   - 着衣色別（明/暗/カメラにブレンド）検出精度
3. エラー回復フロー検証
   - カメラ権限拒否からの回復
   - 検出失敗からの再試行と復帰
   - アプリ強制終了からの状態復元
4. デバイス状態テスト
   - バックグラウンド遷移と復帰時の動作テスト
   - 低バッテリー時の動作テスト（10%/5%）
   - 低メモリ状態での動作テスト
5. ポーズ検出精度テスト
   - 様々なボディタイプでの判定精度
   - 様々な姿勢角度での検出精度
   - 関節角度判定の一貫性テスト
6. パフォーマンステスト
   - 連続30分使用時の発熱とバッテリー消費
   - メモリリークチェック（24時間テスト）
   - CPU/GPU使用率と温度モニタリング
7. アクセシビリティテスト
   - スクリーンリーダー対応検証
   - 色覚異常シミュレーション下での操作性
   - 様々な環境光下での視認性

## リリース基準
- **最低限のフロー完了**: ホーム → レッスン選択 → ポーズ検出 → 結果表示
- **エラーレート**: 
  - 検出精度70%以上（標準照明下）
  - クラッシュ率0.5%未満
  - ANR（アプリ無応答）0.3%未満
- **パフォーマンス基準**:
  - 起動時間3秒以内
  - フレームレート最低15FPS維持
  - メモリ使用量ピーク200MB以下
- **UX基準**:
  - テストユーザーによる操作成功率90%以上
  - タスク完了時間の目標達成
  - SUS（System Usability Scale）スコア70以上

## セキュリティ要件
- **データ保護**:
  - ローカルデータの暗号化保存
  - 安全なキーストレージの使用
  - バックアップデータの暗号化
- **アプリ保護**:
  - 改ざん検知機能（本番環境）
  - デバッグ防止（本番環境）
  - ルート検知（オプション）

## ドキュメント要件
- **開発者向け**:
  - アーキテクチャ概要図の更新
  - APIドキュメント（JSDoc形式）
  - 状態遷移図の詳細化
- **テスト担当者向け**:
  - テストケース詳細書
  - エラー再現手順書
  - 受け入れ基準チェックリスト
- **ユーザー向け**:
  - チュートリアル画面
  - ヘルプセンターコンテンツ
  - トラブルシューティングガイド
